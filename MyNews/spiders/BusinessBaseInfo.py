# -*- coding: utf-8 -*-
'''
POST /api.qixin.com/APIService/v2/enterprise/searchListPaging HTTP/1.1
Host: 120.77.35.204:8888
Content-Length: 56
Accept: */*
Origin: http://www.qheedata.com
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Referer: http://www.qheedata.com/index.html
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.8
Connection: close

keyword=k&skip=0&appkey=834e296f80ce4dadadca3c03caab08b2

---------------------------------
{"status":"200","message":"操作成功","sign":"7b72bfc85b5c49eeba9f61fcf5452a3a","data":{"total":2328711,"num":20,"items":[{"name":"西门子（中国）有限公司","id":"12de98a9-b06d-421e-b2d6-dc8c888cb9db","start_date":"1994-10-06","oper_name":"奈柯（CedrikNeike）","reg_no":"91110000625907585K","credit_no":"91110000625907585K"},{"name":"中国华信能源有限公司","id":"e163eb47-e1c9-4fa0-8b19-1c2cc44ccf4d","start_date":"1980-01-01","oper_name":"陈秋途","reg_no":"91310000128515986K","credit_no":"91310000128515986K"},{"name":"新时代健康产业（集团）有限公司","id":"f228b857-8b7f-4ea9-a863-159bffe1a3c6","start_date":"2004-10-29","oper_name":"刘国平","reg_no":"91110000710932945K","credit_no":"91110000710932945K"},{"name":"宝马汽车金融（中国）有限公司","id":"0a847fa6-ca9a-41cb-826d-d9da48107858","start_date":"2010-09-30","oper_name":"诺丹清","reg_no":"91110000717884675K","credit_no":"91110000717884675K"},{"name":"神州高铁技术股份有限公司","id":"cbf623b8-9d1a-4e1c-a94c-1a0b8e4c3f9a","start_date":"1989-10-11","oper_name":"王志全","reg_no":"91110000192184333K","credit_no":"91110000192184333K"},{"name":"中国建筑集团有限公司","id":"bfedf508-a4a5-4824-b4ca-40218b6738fd","start_date":"1983-03-24","oper_name":"官庆","reg_no":"91110000100001035K","credit_no":"91110000100001035K"},{"name":"华电煤业集团有限公司","id":"27616846-62af-4ce7-846b-5937bb9bcfe2","start_date":"2005-09-08","oper_name":"王旺旺","reg_no":"91110000710933614K","credit_no":"91110000710933614K"},{"name":"新疆喀什农村商业银行股份有限公司","id":"451d3a27-2a52-4e1f-9dac-1acb8e14a0de","start_date":"2014-07-25","oper_name":"田晓东","reg_no":"91653100313307636K","credit_no":"91653100313307636K"},{"name":"中国稀有稀土股份有限公司","id":"ccaefe35-ee35-490e-b78f-06da25d7c021","start_date":"1988-04-12","oper_name":"丁海燕","reg_no":"91110000100007699K","credit_no":"91110000100007699K"},{"name":"滨州市财金投资集团有限公司","id":"43ee30b3-548a-46d7-86de-69e59d180186","start_date":"1992-07-17","oper_name":"索立新","reg_no":"91371600494580948K","credit_no":"91371600494580948K"},{"name":"嘉友国际物流股份有限公司","id":"b45d50f0-b7b4-4f88-88bb-f16fcd7bbd7a","start_date":"2005-06-22","oper_name":"韩景华","reg_no":"91110102777084506K","credit_no":"91110102777084506K"},{"name":"北京中航泰达环保科技股份有限公司","id":"4c3819e9-5c02-420f-8360-e7bc89761658","start_date":"2011-12-19","oper_name":"刘斌","reg_no":"91110106587714554K","credit_no":"91110106587714554K"},{"name":"威海海马地毯集团有限公司","id":"fe49b0c8-be4f-454c-b02f-4e86661180a8","start_date":"1981-06-16","oper_name":"张波","reg_no":"91371000166681010K","credit_no":"91371000166681010K"},{"name":"上海睿昂生物技术有限公司","id":"1da20733-deb7-42fc-8606-e070c61dc92a","start_date":"2012-02-17","oper_name":"熊慧","reg_no":"91310120590029056K","credit_no":"91310120590029056K"},{"name":"中国航空工业集团有限公司","id":"ec8437ea-462c-45e9-b109-6c97ff76ef03","start_date":"2008-11-06","oper_name":"谭瑞松","reg_no":"91110000710935732K","credit_no":"91110000710935732K"},{"name":"江苏领航服务外包有限公司","id":"2cfc0ee3-d45d-4ad7-96e6-cf75e639922e","start_date":"2007-04-03","oper_name":"杨衡","reg_no":"91320111660650308K","credit_no":"91320111660650308K"},{"name":"陕西陕煤曹家滩矿业有限公司","id":"6e7167a1-b860-4c55-9527-c31e2796f089","start_date":"2012-04-24","oper_name":"路山潮","reg_no":"91610000593327534K","credit_no":"91610000593327534K"},{"name":"浙江摩多巴克斯科技股份有限公司","id":"2a1e232c-08e5-4fab-8d0e-34f3542ebe55","start_date":"2006-04-26","oper_name":"陆志伟","reg_no":"91330200786772896K","credit_no":"91330200786772896K"},{"name":"惠多利农资有限公司","id":"299ce3c8-72a3-439c-9420-040ee0b58e53","start_date":"2008-04-08","oper_name":"陈达会","reg_no":"91330000673879662K","credit_no":"91330000673879662K"},{"name":"江苏三掌信息科技有限公司","id":"3f4dc80d-b86c-4f78-b4c0-b11743f08c80","start_date":"2013-03-21","oper_name":"马长林","reg_no":"91320506064516348K","credit_no":"91320506064516348K"}]}}

---------------------
POST /qhd-web/appapi/v2/query/moreQyInfoP1.do HTTP/1.1
Host: xinren.qheedata.com:9080
Content-Length: 39
Accept: */*
Origin: http://xinren.qheedata.com:9080
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Linux; Android 8.0.0; VKY-AL00 Build/HUAWEIVKY-AL00; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/67.0.3396.87 Mobile Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Referer: http://xinren.qheedata.com:9080/qhd-web/app/temp/qydetail.html?monId=344130f0-af31-4399-a48d-013afeb01c7e
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,en-HK;q=0.9,en-US;q=0.8
Cookie: JSESSIONID=
Connection: close

id=ae88cee5-acfc-4f2e-8570-7c3c934786b6
------------------------
{"code":200,"message":"用户ID或者企业ID为空","data":{"_id":{"counter":14469304,"date":{"date":2,"day":1,"hours":6,"minutes":18,"month":3,"seconds":17,"time":1522621097000,"timezoneOffset":-480,"year":118},"machineIdentifier":7969364,"processIdentifier":10928,"time":1522621097000,"timeSecond":1522621097,"timestamp":1522621097},"baseInfo":{"startDate":"2000年04月11日","regCapi":"5000 万人民币","name":"融汇通网络服务股份有限公司","regInfo":{"status":"在营（开业）企业","creditNo":"91370212718056601M","orgNo":"718056601","businessTerm":"2000年04月11日到-","belongOrg":"青岛市工商行政管理局","econKind":"其他股份有限公司(非上市)","regNo":"370212228050772","address":"青岛崂山区软件园软件大厦A区五楼","scope":"计算机信息系统的研发、销售及运营服务；受托对企业资产进行运营管理；金融专用设备及辅助设施的研发、生产、销售、租赁、维修、维护及运营管理。（依法须经批准的项目，经相关部门批准后方可开展经营活动）","checkDate":"2017年04月05日"},"operName":"刘涛"},"tyc_id":"ae88cee5-acfc-4f2e-8570-7c3c934786b6","companyInfo":{"logoUrl":"//cc1.intsig.net/cc/qiye/vip/camfs/qxb/11111_57949395e6aeac01935a6e7d0d07643e"},"tag":"其它社交网络 ","attentioned":true},"extData":null,"pageSize":0,"pageNo":0,"totalRecords":0,"totalPages":0}
------------------------

'''

import json
import csv

from scrapy_redis.spiders import RedisSpider
from MyNews.items import companybase_personItem
from scrapy import Request
import requests
from lxml import etree

class BusinessBaseInfoSpider(RedisSpider):
    """Spider that reads urls from redis queue (qqnews:start_urls)."""


    #start_url = "http://stock.eastmoney.com/news/cgszb.html"

    name = 'BusinessBaseInfo'
    redis_key = 'BusinessBaseInfo:start_urls'
    def __init__(self, *args, **kwargs):
        # Dynamically define the allowed domains list.
        domain = kwargs.pop('cninfo.com.cn', 'www.cninfo.com.cn')
        #self.allowed_domains = filter(None, domain.split(','))
        super(BusinessBaseInfoSpider, self).__init__(*args, **kwargs)

    def parse(self,response):
        # 取得总页数
        #r = requests.get('http://www.cninfo.com.cn/information/management/szmb000001.html')
        #html = etree.HTML(r.text)
        # 循环遍历所有页
        csv_reader = csv.reader(open('businessname.csv', encoding='utf-8'))
        for row in csv_reader:
            i=row[0]
            # 得到每页的url
            header={'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8','User-Agent':'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36'}
            url='http://120.77.35.204:8888/api.qixin.com/APIService/v2/enterprise/searchListPaging'
            metavalue={'keyword':str(i),'skip':'0','appkey':'834e296f80ce4dadadca3c03caab08b2'}
            yield Request(url,callback=self.parsebody,method='POST',header=header,dont_filter=True,meta=metavalue)

    # 抽取页面数据
    def parsebody(self,response):
        meta = response.meta
        r=response
        newsjson = json.loads(response.text)
        print(newsjson)
        vrows=r.xpath("//div[@class='clear']/table/tr")
        for i in range (1,len(vrows)):
            #print(vrows[i].extract())
            item = companybase_personItem()
            item['stkcode']=r.xpath("//form//tr/td[1]/text()").extract()[0]
            item['stkname']=r.xpath("//form//tr/td[1]/text()").extract()[1]
            item['personname']=vrows[i].xpath('td/text()')[0].extract().replace('\r','').replace('\n','')
            item['personjob']=vrows[i].xpath('td/text()')[1].extract().replace('\r','').replace('\n','')
            item['personbirth']=vrows[i].xpath('td/text()')[2].extract().replace('\r','').replace('\n','')
            item['personsex']=vrows[i].xpath('td/text()')[3].extract().replace('\r','').replace('\n','')
            item['personedu']=vrows[i].xpath('td/text()')[4].extract().replace('\r','').replace('\n','')
            item['url'] = response.url
            item['body'] =vrows[i].xpath('td/text()')[0].extract().replace('\r','').replace('\n','')+vrows[i].xpath('td/text()')[0].extract().replace('\r','').replace('\n','')+vrows[i].xpath('td/text()')[1].extract().replace('\r','').replace('\n','')
            yield item